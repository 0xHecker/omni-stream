name: Build And Publish Desktop Binaries

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

env:
  UV_VERSION: "0.10.4"
  PYINSTALLER_VERSION: "6.19.0"

jobs:
  build-and-package:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Clone repository at current revision
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO_HOST="${GITHUB_SERVER_URL#https://}"
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@${REPO_HOST}/${GITHUB_REPOSITORY}.git"
          git config --global --add safe.directory "$PWD"
          if [ -d .git ]; then
            git remote remove origin || true
          else
            git init .
          fi
          git remote add origin "$REPO_URL"
          git fetch --depth=1 --force origin "$GITHUB_REF"
          git checkout --force FETCH_HEAD

      - name: Ensure Python on Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Ensure Python on macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
            exit 0
          fi
          brew install python@3.11 || brew install python

      - name: Ensure Python on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Get-Command python -ErrorAction SilentlyContinue) { exit 0 }
          if (Get-Command py -ErrorAction SilentlyContinue) { exit 0 }
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install python --yes
            exit 0
          }
          throw "Python not found and Chocolatey is unavailable on this runner."

      - name: Resolve Python command and install uv
        shell: bash
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then
            PYTHON_BIN=python
          elif command -v python3 >/dev/null 2>&1; then
            PYTHON_BIN=python3
          else
            echo "Python is not available on this runner."
            exit 1
          fi
          "$PYTHON_BIN" - <<'PY'
          import sys
          required = (3, 11)
          current = sys.version_info[:2]
          if current < required:
              raise SystemExit(f"Python {required[0]}.{required[1]}+ required, found {current[0]}.{current[1]}")
          PY
          "$PYTHON_BIN" --version
          "$PYTHON_BIN" -m pip install --upgrade pip "uv==$UV_VERSION"
          echo "PYTHON_BIN=$PYTHON_BIN" >> "$GITHUB_ENV"

      - name: Resolve version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$("$PYTHON_BIN" - <<'PY'
          import re
          from pathlib import Path
          text = Path("pyproject.toml").read_text(encoding="utf-8")
          match = re.search(r'(?m)^version\s*=\s*"([^"]+)"', text)
          if not match:
              raise SystemExit("Version not found in pyproject.toml")
          print(match.group(1))
          PY
          )
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            TAG_VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$TAG_VERSION" != "$VERSION" ]]; then
              VERSION="$TAG_VERSION"
            fi
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Sync dependencies
        shell: bash
        run: |
          set -euo pipefail
          "$PYTHON_BIN" -m uv sync --frozen

      - name: Build binary
        shell: bash
        run: |
          set -euo pipefail
          "$PYTHON_BIN" -m uv run python scripts/build_binary.py

      - name: Smoke test built binary
        shell: bash
        run: |
          set -euo pipefail
          "$PYTHON_BIN" -m uv run python scripts/smoke_binary.py --runner-os "${{ runner.os }}"

      - name: Package binary
        shell: bash
        run: |
          set -euo pipefail
          "$PYTHON_BIN" -m uv run python scripts/package_binary.py --version "$VERSION" --runner-os "${{ runner.os }}"
          ls -la packages

      - name: Resolve publish release tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            PUBLISH_TAG="${GITHUB_REF#refs/tags/}"
          else
            PUBLISH_TAG="edge"
          fi
          echo "PUBLISH_TAG=$PUBLISH_TAG" >> "$GITHUB_ENV"

      - name: Publish GitHub release assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          FILES=(packages/*)
          if [[ "${#FILES[@]}" -eq 0 ]]; then
            echo "No package files found to publish."
            exit 1
          fi
          "$PYTHON_BIN" scripts/publish_release_assets.py --tag "$PUBLISH_TAG" --files "${FILES[@]}"

  publish-ghcr-package:
    needs: build-and-package
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Clone repository at current revision
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO_HOST="${GITHUB_SERVER_URL#https://}"
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@${REPO_HOST}/${GITHUB_REPOSITORY}.git"
          git config --global --add safe.directory "$PWD"
          if [ -d .git ]; then
            git remote remove origin || true
          else
            git init .
          fi
          git remote add origin "$REPO_URL"
          git fetch --depth=1 --force origin "$GITHUB_REF"
          git checkout --force FETCH_HEAD

      - name: Ensure Python on Ubuntu runner
        shell: bash
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Resolve Python command
        shell: bash
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then
            PYTHON_BIN=python
          elif command -v python3 >/dev/null 2>&1; then
            PYTHON_BIN=python3
          else
            echo "Python is not available on this runner."
            exit 1
          fi
          "$PYTHON_BIN" --version
          echo "PYTHON_BIN=$PYTHON_BIN" >> "$GITHUB_ENV"

      - name: Resolve publish release tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            PUBLISH_TAG="${GITHUB_REF#refs/tags/}"
          else
            PUBLISH_TAG="edge"
          fi
          echo "PUBLISH_TAG=$PUBLISH_TAG" >> "$GITHUB_ENV"

      - name: Download release assets
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          "$PYTHON_BIN" scripts/download_release_assets.py --tag "$PUBLISH_TAG" --out-dir ghcr-assets
          ls -la ghcr-assets

      - name: Build and push GHCR package
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER_LOWER="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          REPO_NAME_LOWER="$(echo "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${OWNER_LOWER}/${REPO_NAME_LOWER}-binaries"
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-12)"

          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
            IMAGE_ALIAS="latest"
          else
            IMAGE_TAG="sha-${SHORT_SHA}"
            IMAGE_ALIAS="edge"
          fi

          cat > Dockerfile.ghcr <<EOF
          FROM scratch
          LABEL org.opencontainers.image.title="stream-local-binaries"
          LABEL org.opencontainers.image.description="Prebuilt desktop binaries for stream-local-files-on-same-network"
          LABEL org.opencontainers.image.source="https://github.com/${GITHUB_REPOSITORY}"
          LABEL org.opencontainers.image.version="${IMAGE_TAG}"
          COPY . /artifacts/
          EOF

          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
          docker build -f Dockerfile.ghcr -t "${IMAGE}:${IMAGE_TAG}" -t "${IMAGE}:${IMAGE_ALIAS}" ghcr-assets
          docker push "${IMAGE}:${IMAGE_TAG}"
          docker push "${IMAGE}:${IMAGE_ALIAS}"
